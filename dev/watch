const fs = require('fs')
const rollup = require('rollup')

let isRolling = false

function roll (filename) {
  let date = new Date()
  let now = [
    date.getHours(),
    date.getMinutes(),
    date.getSeconds(),
  ].join(':')
  console.log(
    '[' + now + ']',
    filename
  )
  if (isRolling) return
  isRolling = true
  rollup.rollup({
    entry: './src/index.js',
  }).then(function (bundle) {
    bundle.write({
      format: 'cjs',
      dest: './dev/dev.js',
    })
    isRolling = false
  })
}

fs.watch('./src', {
  persistent: true,
  interval: 20000,
}, function (event, filename) {
  if (
    filename &&
    event === 'change'
  ) {
    roll(filename)
  }
})

roll('Init')
